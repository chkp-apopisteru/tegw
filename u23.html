<html>

<head>
    <title>SandBlast - file testing page</title>
</head>

<body>

<!---
/opt/CPUserCheckPortal/htdocs/UserCheck/u23.html
chown nobody:nobody u23.html

Willys TP
tp_conf_service --conf=tp_conf.json --log=info
Debug file could be found under $FWDIR/log/tp_conf.log

$FWDIR/log/tp_inifnity_rb_converter.elg
TP inifnity Rulebase will be simulated in:
/opt/CPsuite-R80.40/fw1/conf/install_manager_tmp/ANTIMALWARE_CURRENTVERCMP/conf/am_infinity_rulebase.C

# haproxy https://wiki.checkpoint.com/confluence/display/SALES/SandBlast+private+cloud+API+Load-Sharing+with+HAProxy

/opt/CPUserCheckPortal/conf/php.ini :
post_max_size = 8M
upload_tmp_dir = /opt/CPUserCheckPortal/log

/opt/CPUserCheckPortal/conf/httpd.conf :
LimitRequestBody 10000000

/opt/CPUserCheckPortal/phpincs/conf/TPAPI.ini instead
is_scrub_web_service_api_disabled = FALSE;
Change gateway file /opt/CPUserCheckPortal/htdocs/UserCheck/ScrubService
Find line
is_scrub_web_service_api_disabled = TRUE;
https://wiki.checkpoint.com/confluence/display/PRODUCTINFO/Threat+Prevention+Unified+API

mpclient getdata UserCheck
https://<IP_Address_of_Security_Gateway>/UserCheck/TPAPI
Expected response (refer to Check Point Threat Prevention API Reference Guide):
"{"response":[{"protocol_version":"1.1","src_ip":""}]}".
--->
    <form>
        <input type="file" id="files" name="files" multiple="false"/>
    </form>
	
    <script>
        console.log("ready.");
        // used as TE API key
        api_key = "kiR1trIRt7dk3VF9TeijEpwE38PXfvg5"

        window.tpapi = {
            key: "",
            sender_string: "SimpleUploadPage"
        }

        function queryFile(teStruct)
        {
            console.log("queryFile ", teStruct);

            var jsonRequest = {
                request: [{
                    protocol_version: "1.1",
                    file_name: teStruct.file_name,
                    file_type: teStruct.file_type,
                    features: ["te"]
                }]
            };
            console.log("queryFile JSON ", jsonRequest);

            var qReq = new XMLHttpRequest
           
            // once done
            qReq.onload = function () {
                console.log("file query status: ", qReq.status);
                if (qReq.status === 200) {
                    console.log(qReq.responseText);
                    updateOutput("Server response for QueryFile:\n"+f1.responseText);
                    handleAPIResponse(qReq.responseText);
                } else {
                    console.log("Error file query request with code ", qReq.status, qReq.statusText);
                    updateOutput("Error quering file");
                }
            }
            try {
                console.log("queryFile request", jsonRequest);
                k = JSON.stringify(jsonRequest),
                //d = k.length,
                server_url = "/UserCheck/TPAPI",
                qReq.open("POST", server_url, !0),
                //qReq.setRequestHeader("Authorization", api_key),
                qReq.timeout = 3E5,
                qReq.send(k)
                console.log("Server URL ", server_url)
            } catch (q) {
                console.log("Error quering file ", q);
            }
        }

        function handleAPIResponse(resp)
        {
            try {
                apiResponse = JSON.parse(resp);
                console.log(apiResponse);
                setStatusTable(apiResponse.response[0].te.status);


                // verdict 1001 FOUND
                if (apiResponse.response[0].te.status.code === 1001) {
                    console.log("FOUND");

                    //setVerdictTable(apiResponse.response[0].te.te);

                    if (apiResponse.response[0].te.te.combined_verdict === "Malicious") {
                        if (apiResponse.response[0].te.te.images) {
                            setReportsTable(apiResponse.response[0].te.te.images);
                        }
                    }

                    console.log(apiResponse.response[0].te.status.code);
                    console.log(apiResponse.response[0].te.status.label);
                    console.log(apiResponse.response[0].te.status.message);
                    console.log(apiResponse.response[0].te.te.combined_verdict);
                } else if (apiResponse.response[0].te.status.code === 1004) {
                    //setStatusTable({code: "N/A", label: "N/A", message: "Error processing file. Unexpected code 1004"});
                    //setVerdictTable(apiResponse.response[0].te.te);
                    //setElementVisibility(document.getElementById("more_link"), true);
					console.log("1004");
                } else {
                    // 1003 PENDING, 1002 UPLOAD_SUCCESS, 1006 PARTIALLY_FOUND
                    if ((apiResponse.response[0].te.status.code == 1003) || (apiResponse.response[0].te.status.code == 1002) || (apiResponse.response[0].te.status.code == 1006)) {
                        window.sb_queryFileCheck = setTimeout(function(){
                            console.log("Checking status of "+ apiResponse.response[0].te.sha1);
                            queryFile(apiResponse.response[0].te);
                        }, 30000);
                    } else {


                        console.log("Error parsing server response; Status code " + apiResponse.response[0].te.status);
                        console.log(apiResponse.response[0]);
                    }
                }
            } catch (e) {
                console.log("Error parsing API response: ", e);
            }
        }

        function uploadFile(finfo, fcontent) {
            console.log("uploadFile ", finfo);

            // build JSON request for /UserCheck/TPAPI interface
            var jsonRequest = {
                request: [{
                    protocol_version: "1.1",
                    //api_key: window.tpapi.key,
                    request_name: "UploadFile",
                    api_key: api_key,
                    sender: window.tpapi.sender_string,
                    file_orig_name: finfo.name,
                    file_enc_data: fcontent
                }]
            };
            jsonRequest.request[0].te_options = {
                file_name: finfo.name,
                file_type: finfo.name.split('.').pop(), // file extension used
                is_base64: true,
                features: ["te"]
            };

            // build and execute request
            var f = new XMLHttpRequest;
            
            // once done
            f.onload = function () {
                console.log("file upload status: ", f.status);
                if (f.status === 200) {
                    console.log(f.responseText);
                    handleAPIResponse(f.responseText);
                    updateOutput("Server response:\n"+f.responseText);
                    checkResponse(f.responseText);
                } else {
                    console.log("File upload failed")
                    updateOutput("Error uploading file");
                }
            }
            try {
                console.log("uploadFile request", jsonRequest);
                k = JSON.stringify(jsonRequest),
                console.log("JSON request", k)
                d = k.length,
                // request goes to this script server
                server_url = "/UserCheck/TPAPI",
                f.open("POST", server_url, !0),
                //f.setRequestHeader("Authorization", api_key),
                f.timeout = 3E5,
                f.send(k)
            } catch (q) {
                console.log("Error uploading file ", q);
                updateOutput("Error uploading file");
            }

        }

        function handleFileSelect(evt) {
            console.log(evt.target);

            // hide upload button
            setElementVisibility(document.getElementById("files"), false);

            // update status
            setFileDetailsTable(evt.target.files[0]);
            setStatusTable({code: "N/A", label: "N/A", message: "Uploading file"});

            startProgressIndicator();

            // one or more files selected
            var files = evt.target.files;

            // files is a FileList of File objects. List some properties.
            for (var i = 0, f; f = files[i]; i++) {
                console.log("Processing file: " + f.name);
                //updateOutput('Uploading ' + escape(f.name));

                var reader = new FileReader();

                // closure to contain file information
                reader.onload = (function (theFile) {
                    return function (e) {
                        var base64EncodedFileContent = e.target.result.match(/,(.*)$/)[1];
                        uploadFile(theFile, base64EncodedFileContent);
                    };
                })(f);

                // process this file
                reader.readAsDataURL(f);
            }
        }

        // respond to file selection
        document.getElementById('files').addEventListener('change', handleFileSelect, false);
    </script>
</body>

</html>